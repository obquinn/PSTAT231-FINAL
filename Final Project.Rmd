---
title: "Opening the 'Black Box' of Legislative Organization in Congress: Using Machine Learning to Predict Freshman Committee Placements"
author: "Olivia Quinn"
date: "4/10/2022"
output: 
  html_document:
      toc: true
      toc_float: true
      code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      warning = FALSE)
```

## Introduction 

### Research Question

- [import from google doc]

### Theoretical Importance

- [import from google doc]

### Practical Application

- [import from google doc]
  
**Load packages:**
```{r}
library(readr)
library(tidyverse)
library(janitor)
#install.packages("corrplot")
library(corrplot)
library(tidymodels)
library(ggthemes)
library(glmnet)
```

## Data: Loading, Cleaning, and Merging
  
**Read in the Data from two sources:** 
- 1) Foster-Molina: [describe here] The Member/District data set has committee assignments from only the 109th - 113th Congresses (covering the 10 year period from 2005-2015)

- 2) Bonica's DIME data: [describe here]
```{r}
#MC/District Data from Prof. Ella Foster-Molina (range: 1972-2013)
MCdistDat <- read_csv("Data/MC:Dist data 72-2014/allCongressDataPublishV2.csv")

#DIME data (pre-Congress ideology score based on campaign contributions) from Prof. Adam Bonica
load("Data/DIME data/dime_recipients_all_1979_2014.rdata")

district <- as_tibble(MCdistDat) %>% 
  clean_names()

dime <- as_tibble(cands.all) %>% 
  clean_names()
```
  
 
**Clean and Subset the Member/District Data:**
```{r}
fresh <- district %>% 
  filter(com_name != "NA" & number_terms == 1) %>% 
  relocate(icpsr, last_name, first_name, gender, cong_num, frac_served, state_dist, party, cook_lean_dem, region, com_name, .before = everything())

fresh <- fresh %>% 
  rename(icpsr2 = icpsr)   #to match dime column 'icpsr2' for later merge 

#fix select committee entries (MCs Patrick Murphy and Joseph Heck) so they run through outcome variable splitting function correctly
fresh[94,11] = "House Committee on Armed Services House Committee on Permanent Select Committee on Intelligence"
fresh[219,11] = "House Committee on Armed Services House Committee on Education and the Workforce House Committee on Permanent Select Committee on Intelligence"
fresh$icpsr2 <- as.character(fresh$icpsr2)


```

DIME data -- subset and make usable

subset dime data set for 'cycles' lining up with 109-113 congress (caution for special elections - noted often by frac_served - which means first election in dime dat is really first regular election... see e.g. Matsui in CA05 who is elected in march of 2005, served 90% of 109th congress, but first dime entry is 2006 cycle (to serve first 'full term' in 110th congress)... same with Byrne in AL01 who is elected in 2013, serves in 113th congress, but whose first dime entry is 2014 (to serve first 'full term' in 114th(2015-2017))) ** treat these as NAs until better coding convention can be developed

FEC cycle 2004 = 109th Congress (2005-2007)  
FEC cycle 2006 = 110th Congress (2007-2009)  
FEC cycle 2008 = 111th Congress (2009-2011)  
FEC cycle 2010 = 112th Congress (2011-2013)  
FEC cycle 2012 = 113th Congress (2013-2015)  

**Clean/subset DIME data:**
```{r}
# subset dime for federal House elections & create 'cong_num' variable based on election 'cycle' year noted above. 
dime <- dime %>% 
  filter(seat == "federal:house") %>%   
    mutate(cong_num = ifelse(cycle == 2004, 109,   
                         ifelse(cycle == 2006, 110, 
                             ifelse(cycle == 2008, 111,
                                 ifelse(cycle == 2010, 112, 
                                     ifelse(cycle == 2012, 113, 0))))))
                                        
#subset dime for Member identification variables and theorized predictors
dime <- dime %>% 
  select(icpsr2, name, election, cycle, cong_num, district, 
         winner, party_orig, party, recipient_cfscore, total_receipts, num_givers, 
         total_pc_contribs, party_coord_exp, total_pac_contribs, 
         non_party_ind_exp_for, ind_exp_for, district_partisanship, district_pres_vs)

#re-code Representative Griffith whose ICPSR code is incorrect in DIME data
dime <- dime %>% 
  mutate(icpsr2 = recode(icpsr2, "AL8291" = "20901"))
```
  
**Merge DIME data with Freshman Member/District data:**
```{r}
dat <- left_join(fresh, dime, by = c("icpsr2", "cong_num")) 

#organize new dat
dat <- dat %>%  
  relocate(icpsr2, last_name, name, election, cycle, cong_num, winner,.before = everything()) %>% 
  relocate(district_partisanship, district_pres_vs, .before = cook_lean_dem) %>% 
  relocate(state, cd, .before = state_dist) %>% 
  relocate(party_orig, party.y, .before = party.x)

#remove extraneous variables & overlap from merge (after confirming that name & last_name match, e.g.)
dat <- dat %>%
  subset(select = -c(spon_id, num_spon, num_cosp, num_pass_h, num_enact, pass_prcnt, middle_name, 
                     under10k, over10k, over15k, over25k, over35k, over50k, over75k, over100k, over150k, over200k, 
                     chair, rank, rank_chair, days_served, prcnt_black, prcnt_white_all, 
                     dwnom1, dwnom2, election, name, statenm, district.x, district.y, full))
```
  
**Create outcome variables `com_1` - `com_4`:**
```{r}
dat <- dat %>% 
  separate(com_name, c("A","com_1","com_2", "com_3", "com_4"), sep = "House Committee on") %>% 
  subset(select = -A) %>% 
  mutate(com_1 = trimws(com_1, which = c("both"))) %>% 
  mutate(com_2 = trimws(com_2, which = c("both"))) %>% 
  mutate(com_3 = trimws(com_3, which = c("both"))) %>% 
  mutate(com_4 = trimws(com_4, which = c("both")))
#A goes unfilled because it represents everything before the first instance of "House Committee on" which is nothing 


# ~~~ Group the various historical names to a higher, 'simple' common name category ~~~ 
# ~~(provided by Congress.gov https://www.congress.gov/help/committee-name-history)~~

dat <- dat %>% 
  mutate_at(c("com_1", "com_2", "com_3", "com_4"), funs(recode(., "Education and the Workforce" = "Education and Labor", 
              "Government Reform" = "Oversight and Reform", 
              "Oversight and Government Reform" = "Oversight and Reform", 
              "International Relations" = "Foreign Affairs",
              "Resources" = "Natural Resources",
              "Science" = "Science, Space, and Technology", 
              "Science and Technology" = "Science, Space, and Technology",
              "Standards of Official Conduct" = "Ethics",
              "the Budget" = "Budget",
              "the Judiciary" = "Judiciary")))

#bind together and check all committee placement variables for mis-codes
com_1 <- as_tibble(dat$com_1)
com_2 <- as_tibble(dat$com_2)
com_3 <- as_tibble(dat$com_3)
com_4 <- as_tibble(dat$com_4)

com_assign_all <- bind_rows(com_1, com_2, com_3, com_4)
com_assign_all <- na.omit(com_assign_all)

table(dat$com_1)
```

**Identify and troubleshoot missingness:**
```{r}
# ~~ MEMBERS WHO SERVED ONLY FRACTION OF FULL CONGRESSIONAL SESSION ~~
part_term <- dat %>% 
  filter(frac_served < 1)
# 30 members who served less than 1 full session as a freshman either won a special election in the middle of the session, or resigned/retired/died etc. Often there is no DIME data because there is no FEC fundraising period for Bonica to work from. The other variables should predict placements however..

# ~~ MISSING ELECTION CYCLE ~~
no_cycle <- dat %>% 
  filter(is.na(cycle))
# mostly captures frac_served < 1 (so reflects special elections not getting coded in DIME)
# [RECODE LATER] Adler: 20928... I believe a DIME mis-code given he did win in 2008, served in 11th Congress. Coded as senate race in cands.all?
# [RECODED] Griffith: AL8291... icpsr code is wrong in DIME, fixed above

# ~~NO ICPSR CODE~~ 
# returns MCs from Puerto Rico and Northern Mariana Islands (they can't vote in Congress anyhow)
no_icpsr <- dat %>% 
  filter(is.na(icpsr2))

# ~~LOSERS~~
losers <- dat %>% 
  filter(winner == "L")
# Ellsworth won in 2006 and served in 110th Congress -- so that's a DIME mis-code? Ignore
# Turner runs and loses in 2010 but is elected in a 2011 special election to fill same seat. Wins that election and serves fraction of 112th Congress. 
# Garcia won in 2012 and served in 113th Congress -- so that's a DIME mis-code? Ignore
# Kildee won in 2012 and served in 113th Congress -- so that's a DIME mis-code? Ignore

# ~~OTHER MISSINGNESS?~~
#colSums(is.na(dat))
```

**Identify Party Switchers:**
```{r}
switchers <- dat %>% 
  filter(party_orig != party.y)

#returns none, but I know P. Griffith from AL did switch to R in 2009 after being elected as a D in 2008. re-code and fix. 
#looks like Griffith is the only to do so across Congress and my time period of interest.  (https://en.wikipedia.org/wiki/List_of_United_States_representatives_who_switched_parties) His committee assignment reflects the Energy & Commerce position he gained when he switched to R. He had to forfeit the D placements he had for a majority of 2009.

#Recode Rep. Griffith's "party_orig" manually [move this somewhere else]
dat[102,12] = "100"
```
  
**Save as new dataset:** 
```{r}
save(dat, file = "dat.rda")
```
  
### Predictor and Outcome Variables 

Main predictor and outcome variables. Full codebook available in github project file. 
  
- `x`
- `y`


## Exploratory Data Analysis 
  
Frequency of Committee placements across all Freshman by First, Second, or Third committee placement   
(*Note*: Fourth committee placements are very rare, and are thus not included for analysis here):  
  
**First:**
```{r}
dat %>% 
  ggplot(aes(x = forcats::fct_infreq(com_1))) +
  geom_bar() +
  coord_flip() +
  labs(title= "First Freshmen Committee Placements across Congresses 109th- 113th (2005-2015)", x = "Committee")
```
  
**Second:**
```{r}
dat %>% 
  ggplot(aes(x = forcats::fct_infreq(com_2))) +
  geom_bar() +
  coord_flip() +
  labs(title= "Second Freshmen Committee Placements across Congresses 109th- 113th (2005-2015)", x = "Committee")
```
  
**Third:**
```{r}
dat %>% 
  ggplot(aes(x = forcats::fct_infreq(com_3))) +
  geom_bar() +
  coord_flip() +
  labs(title= "Third Freshmen Committee Placements across Congresses 109th- 113th (2005-2015)", x = "Committee")
```

**All placements across all Congresses 109th-113th (2005-2015):**
  
Figure indicates that... [xxx]
```{r}
com_assign_all %>% 
  ggplot(aes(x = forcats::fct_infreq(value))) +
  geom_bar() +
  coord_flip() +
  labs(title= "All Freshmen Committee Placements across Congresses 109th- 113th (2005-2015)", x = "Committee")
```

**Histogram: District characteristic X for districts which elected a non-incumbent (Freshman) Member of Congress:**
  
Figure indicates that... [xxx]
  
```{r}

```
  
**Boxplot: First Committee Placement by Ideology (CFscore) and Party**
  
Figure indicates that...[xxx]
  
```{r}
dat %>%
  ggplot() +
    geom_boxplot(mapping = aes(x = com_1, y = recipient_cfscore)) +
    geom_jitter(mapping = aes(x = com_1, y = recipient_cfscore), 
                alpha = .25, 
                height = 0) +
    theme_gdocs() +
    labs(x = "Committee", y = "CFscore by Party") +
    coord_flip() + 
    facet_wrap(~party.y) 
```
  
**Boxplot: First Committee Placement by District Characteristic X**
  
Figure indicates that...[xxx]
  
```{r}
dat %>%
  ggplot() +
    geom_boxplot(mapping = aes(x = com_1, y = prcnt_foreign_born)) +
    geom_jitter(mapping = aes(x = com_1, y = prcnt_foreign_born), 
                alpha = .25, 
                height = 0) +
    theme_gdocs() +
    labs(x = "Committee", y = "prcnt_foreign_born") +
    coord_flip()
```
  
**Lower triangle correlation matrix for (numeric) theorized predictors:** 
  
  Results indicate that conservative districts (indicated by high values of `district_partisanship` and low values of `cook_lean_dem`) are positively correlated with a higher percentage of white people in the district, a slightly lower median income, and a slightly lower education level. Liberal districts are positively correlated with higher percentages of foreign born people, slightly higher median incomes, and a higher education level. Liberal districts are more likely to be represented by a Black freshman in Congress, and to a lesser degree, a hispanic Freshman. 
  Interestingly, `com_power` (an indication of how powerful the committees are that a given Freshman sits on) is slightly positively correlated with conservative districts. Additionally, `party_coord_expenditures` is slightly positively correlated with committee power, indicating that Freshman with greater campaign support from their Party are more likely to receive valuable committee placements.  Number of campaign donors (a rough indicator of candidate populism) is slightly negatively associated with committee power, while total receipts is positively correlated. This might indicate that Freshman members with a greater number of small donors receive less powerful committee placements. 
  
```{r}
dat %>% 
  select(district_partisanship, cook_lean_dem, prcnt_foreign_born, median_income, prcnt_ba, prcnt_white, com_power, num_com, black, hispanic, recipient_cfscore, party_coord_exp, total_receipts, num_givers, total_pc_contribs, total_pac_contribs) %>% 
  cor(use = "pairwise.complete.obs") %>% 
  corrplot(type = "lower")
```
  
## Data Splitting and Cross-Validation

**Data Splitting:**
```{r}

set.seed(24)

#pre-process variable classes
dat <- dat %>% 
  filter(!(com_1 == 'Ways and Means')) %>% 
  filter(!(com_1 == 'House Administration')) %>% 
  filter(!(com_1 == 'Ethics')) %>% #filter out rare (n=1) cases
  filter(!(region == 'territory'))
           

dat <- dat %>% 
  mutate(com_1 = factor(com_1), com_2 = factor(com_2), com_3 = factor(com_3), com_4 = factor(com_4), 
         region = factor(region), 
         party.y = factor(party.y), 
         gender = factor(gender), 
         black = factor(black), 
         hispanic = factor(hispanic))  
 
  

#initial split stratified on the outcome variable
dat_split <- dat %>% initial_split(strata = com_1, prop = 0.85)
dat_train <- training(dat_split)
dat_test <- testing(dat_split)
dim(dat_train)
dim(dat_test)

```
  
**V-Fold Cross-Validation on the training set:**
```{r}
set.seed(24)
dat_folds <- vfold_cv(data = dat_train, v = 3, strata = com_1)
```

## Recipe: to predict `com_1` with `gender`, `party.y`, `age`, `black`, `hispanic`, `recipient_cfscore`, `total_receipts`, `num_givers`, `total_pc_contribs`, `party_coord_exp`, `total_pac_contribs`, `district_partisanship`, `region`, `prcnt_foreign_born`, `prcnt_white`, `median_income`, `prcnt_ba`, and `gini` (dummy the factors + center and scale all predictors):

```{r}
#will be critical in later iterations of this project to capture the conditional effect of party on each of these predictors' effects on committee placement. Planning on doing so soon! 

dat_recipe <- recipe(com_1 ~ gender + party.y + age + black + hispanic + 
                       recipient_cfscore + total_receipts + num_givers + 
                       total_pc_contribs + party_coord_exp + total_pac_contribs + 
                       district_partisanship + region + prcnt_foreign_born + 
                       prcnt_white + gini + ses_norm, data = dat_train) %>% 
              step_dummy(all_nominal_predictors()) %>% 
              step_normalize(all_predictors()) %>% 
              step_naomit(all_predictors())

  
  
```

## Model Fitting

### Model 1: Multinomial regression + fitting and tuning an elastic net, tuning hyperparameters `penalty` and `mixture`

```{r} 
elastic_net_spec <- multinom_reg(penalty = tune(), 
                                 mixture = tune()) %>% 
                    set_mode("classification") %>% 
                    set_engine("glmnet")

en_workflow <- workflow() %>% 
  add_recipe(dat_recipe) %>% 
  add_model(elastic_net_spec)

en_grid <- grid_regular(penalty(range = c(-2, 2)), 
                        mixture(range = c(0, 1)), levels = 5)
```

```{r}
tuned_en_multinom_res <- tune_grid(
  en_workflow,
  resamples = dat_folds, 
  grid = en_grid)

#autoplot(tuned_en_multinom_res) 
##throwing error about NAs and about multinomial class having 1 or 0 observations. 
```


Decision tree: minimize the roc_auc without overfitting — use CV to select optimal pruning penalty 
```{r}

```

Random forest 
```{r}

```

Boosted tree
```{r}

```

## Model Selection and Performance 

```{r}
#compare all 4 models roc-aucs
#tune_res_compare <-  show_best(tune_res, metric = "roc_auc", n = 1)
#rf_compare <- show_best(rf_tune_res, metric = "roc_auc", n = 1)
#boost_compare <- show_best(boost_tune_res, metric = "roc_auc", n = 1)

#AUCs <- c(tune_res_compare$mean, rf_compare$mean, 
                #boost_compare$mean)
#models <- c("Pruned", "RF", "Boosted")
#results <- tibble(AUCs = AUCs, models = models)
#results %>% 
  #arrange(-AUCs)
```


Fit a hypothetical freshman for fun?

## Conclusion 

[xxx]
